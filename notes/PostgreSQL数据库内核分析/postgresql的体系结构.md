# PostgreSQL的体系结构

PostgreSQL数据库由连接管理系统（系统控制器）、编译执行系统、存储管理系统、事务系统、系统表五大部分组成。
**连接管理系统**接受外部操作对系统的请求，对操作请求进行预处理和分发，起系统逻辑控制作用；
**编译执行系统**由查询编译器、查询执行器组成，完成操作请求在数据库中的分析处理和转化工作，最终实现物理存储介质中数据的操作；
**存储管理系统**由索引管理器、内存管理器、外村管理器组成，负责存储和管理物理数据，提供对编译查询系统的支持；
**事务系统**由事务管理器、日志管理器、并发控制、锁管理器组成，日志管理器和驶入管理器完成对操作请求处理的事务一致性支持，锁管理器和并发控制提供对并发访问数据的一致性支持；
**系统表**是PostgreSQL数据库的元信息管理中心，包括数据库对象信息和数据库管理控制信息。

## 系统表

**数据字典**是关系数据库系统管理控制信息的核心，在PostgreSQL数据库系统中，系统表扮演者数据字典的角色。

系统表是PostgreSQL数据库存放结构元数据的地方，它在PostgreSQL中表现为存放有系统信息的普通表或者视图。

PostgreSQL的每一个数据库中都有自己的一套系统表，其中大多数系统表都是在数据库创建时从模板数据库中拷贝过来的，因此这些系统表里的数据都是与所属数据库相关的。只有少数系统表是所有数据库共享的（比如pg_database），这些系统表里的数据是关于所有数据库的。

### 主要系统表功能及依赖关系

1. pg_namespace
   系统表pg_namespace用于存储命名空间。命名空间是SQL92模式下层的结构：每个名字空间有独立的关系、类型等集合，但并不会相互冲突。PostgreSQL的名字空间层次是：数据库.模式.表.属性。
   pg_namespace中每一个元组都对应一个名字空间，每一个名字空间都被分配一个OID（对象标识，用于在整个数据库系统中唯一地标识一个数据库对象，包括数据库、表、视图、索引等）作为唯一标识，并且存储在对应元组的隐层属性（PosrgreSQL中每个元组都有几个用户不可见的属性，用于记录一些系统级的信息）中。

2. pg_tablespace
   pg_tablespace存储表空间信息，将表放置在不同的表空间有助于实施磁盘文件布局。pg_tablespace在整个数据集簇里只有一份，也就是说同一个数据集簇内的所有数据库共享一个pg_tablespace表，而不是每个数据库都有自己的pg_tablespace表。

3. pg_database
   pg_database中存放了当前数据集簇中数据库的信息，它也是一个在整个集簇范围内共享的系统表。

4. pg_class
   pg_class存储表及与表类似结构的数据库对象信息，包含索引、序列、视图、复合数据类型、TOAST表等。

5. pg_type
   pg_type存储数据类型信息。基本数据类型和枚举类型由CREATE TYPE创建，域类型由CREATE DOMAIN创建，复合数据类型在表创建时自动创建。

6. pg_attribute
   pg_attribute存储表的属性信息，对于数据库中表的每一个属性都有一个元组。

7. pg_index
   pg_index存储索引的具体信息。

### 系统视图

除了系统表之外，PostgreSQL还提供了一系列内置的视图，这些视图也是在初试化数据库集簇的时候读取脚本创建的。**系统视图提供了查询系统表和访问数据库内部状态的方法**。

## 数据集簇

由PostgreSQL管理的用户数据库以及系统数据库总称为数据集簇。

在PostgreSQL中，对象标识符（OID）用来在整个数据集簇中唯一地标识一个数据库对象，这个对象可以是数据库、表、索引、视图、元组、类型等。PostgreSQL提供了Oid数据类型来表示OID，它实际上是一个无符号整数。

对于用户表的元组，是可以在创建用户时选择是否具有OID属性的。默认状态下，用户表的元组是没有OID属性的。

OID的分配由系统中的一个全局OID计数器来实现，每次需要分配新的OID时，就从该计数器中取出当前的OID，然后该计数器将会加1。OID分配时会采用互斥锁加以锁定以避免多个要求分配OID的请求获得同一个OID。

初始化数据集簇包括创建包含数据库系统所有数据的数据目录、创建共享的系统表、创建其他的配置文件和控制文件，并创建三个数据库：末班数据库templae1和template0、默认的用户数据库postgres。以后用户创建一个新数据库时，template1数据库里的所有内容（包括系统表文件）都会拷贝过来，因此，任何在template1里面安装的内容都自动拷贝到之后创建的数据库中。template0和postgres都是通过拷贝template1创建的。

对于某个具体的数据库，在PGDATA/base里都对应有一个子目录，子目录的名字是该数据库在系统表pg_database里的OID。

如果一个标的有些属性要存储相当大的数据，那么就会有一个与之相关联的TOAST表，用于存储无法在数据行中放置的超大外置数据。

每个用户定义的表空间在PGDATA/pg_tblspc目录里面都有一个符号链接，它指向表空间的物理目录，该符号链接用表空间的OID命名。系统默认创建的表空间pg_default和pg_global并没有通过符号链接的方式指向其物理目录，而是直接对应PGDATA/base和PGDATA/global。

| 名称            | 类型  | 用途                                                                                                  |
| --------------- | :---: | ----------------------------------------------------------------------------------------------------- |
| PG_VERSION      | 文件  | 一个包含PostgreSQL主版本号的文件                                                                      |
| base            | 目录  | 包含每个数据库目录，数据库目录以数据库的OID编号命名，其中名为1的目录对应模板数据库template1。         |
| global          | 目录  | 包含整个集簇共享的全局表，比如pg_database                                                             |
| pg_clog         | 目录  | 包含事务提交状态数据的子目录                                                                          |
| pg_multixact    | 目录  | 包含多重事务状态数据的子目录（用于共享的行锁）                                                        |
| pg_stat_tmp     | 目录  | 包含统计子系统所需临时文件的子目录                                                                    |
| pg_tbspc        | 目录  | 包含指向表空间的符号链接的子目录                                                                      |
| pg_subtrans     | 目录  | 包含子事务状态数据的子目录                                                                            |
| pg_twophase     | 目录  | 包含用于预备事务的状态文件的子目录                                                                    |
| pg_xlog         | 目录  | 包含WAL（预写日志）文件的子目录                                                                       |
| postmaster.opts | 文件  | 记录服务器上一次启动时使用的命令行参数                                                                |
| postmaster.pid  | 文件  | 一个锁文件，记录着当前的守护进程Postmaster的进程号和共享内存段ID，在服务器关闭后此文件将被删除        |
| postgresql.conf | 文件  | 主要配置文件，除基于主机的访问控制和用户名映射之外的其他用户可设置参数都保存在这个文件中              |
| pg_hba.conf     | 文件  | 基于主机的访问控制文件，保存对客户端认证方式的设置信息                                                |
| pg_ident.conf   | 文件  | 用户名映射文件，定义了操作系统用户名和PostgreSQL用户名之间的对应关系，这些对应关系会被pg_hba.conf用到 |

### initdb的使用

initdb是在使用PostgreSQL之前用于初始化数据集簇的程序，它负责创建数据库目录、系统表、模板数据库。

initdb把用户指定的选项转换成对应的参数，通过外部程序调用的方式执行postgres程序。postgres程序在这种方式下将进入bootstrap模式创建数据集簇，并读取后端接口postgres.bki文件来创建模板数据库。

### postgres.bki

后端接口postgres.bki文件是在编译的过程中有/src/backend/catalog目录下的脚本程序genbki.sh读取/src/include/catalog目录下的以.h结尾的系统表定义文件（包括系统表索引和TOAST表定义文件）创建，并且通常存放在安装树的share字母记录下。

BKI文件仅用于初始化数据集簇。

在有一些基本的系统表（关键表）被创建并初始化其数据之前，不能使用open命令打开非关键系统表。其中关键表包括：pg_class、pg_attribute、pg_proc和pg_type。

在整个源代码被编译时，genbki.sh脚本会被调用，它将从每一个pg_*.h文件中读取系统表定义、系统表的初始化数据、系统表上的索引等信息，然后分别将其转换为对应的BKI命令，最后将所有的BKI命令写入到postgres.bki文件中，该文件的内容如下：

1. 一个“create bootstrap”命令，用于创建其中一个关键表。
2. 一个或多个insert命令，用于填充步骤1创建的关键表中的数据。
3. 一个close命令，用于关闭步骤1创建的关键表。
4. 重复步骤1~3创建和填充其他关键表。
5. 一个不带bootstrap选项的create命令，用于创建一个非关键表。
6. 一个open命令，打开非关键表。
7. 一个或多个insert命令，填充非关键表所需要的数据。
8. 一个close命令，关闭上面打开的非关键表。
9. 重复创建其他非关键表。
10. 一个或多个“declare index”命令，用于定义索引。
11. 一个“build indices”命令，用于实际建立上一步所定义的索引。

### initdb的执行过程

执行initdb程序是，将从initdb.c文件中的main函数开始执行，按照顺序执行下列工作：

1. 根据用户输入的命令行参数获取输入的命令名。
2. 设置系统编码为LC_ALL，查找执行命令的绝对路径并设置该路径。
3. 设置环境变量（pg_data等），获取系统配置文件的源文件路径（postgres.bki、postgresql.conf.sample等文件），并检查该路径下各文件的可用性。
4. 设置中断信号处理函数，对终端命令行SIGHUP、程序中断SIGINT、程序退出SIGOUIT、软件中断SIGTERM和管道中断SIGPIPE等信号进行屏蔽，保证初始化工作顺利进行。
5. 创建数据目录，以及该目录下一些必要的子目录，如base、global、base/1等。
6. 测试当前服务器性能，由测试结果创建配置文件postgresql.conf、pg_hba.conf、pg_ident.conf，并对其中定义的参数做一些设置。
7. 在bootstrap模式下创建数据库template1，存储在数据目录的子目录base/1/中。
8. 创建系统视图、系统表TOAST表等，复制template1来创建template0和postgres，这些操作都是用普通的SQL命令来完成。
9. 打印操作成功等相关信息，退出。

initdb是PostgreSQL中一个独立的程序，它的主要工作就是对数据集簇进行初始化，创建模板数据库和系统表，并向系统表中插入初始元组。在这以后，用户创建各种数据库、表、视图、索引等数据库对象和进行其他操作时，都是在模板数据库和系统表的基础上进行的。
