# PostgreSQL的体系结构

PostgreSQL数据库由连接管理系统（系统控制器）、编译执行系统、存储管理系统、事务系统、系统表五大部分组成。
**连接管理系统**接受外部操作对系统的请求，对操作请求进行预处理和分发，起系统逻辑控制作用；
**编译执行系统**由查询编译器、查询执行器组成，完成操作请求在数据库中的分析处理和转化工作，最终实现物理存储介质中数据的操作；
**存储管理系统**由索引管理器、内存管理器、外村管理器组成，负责存储和管理物理数据，提供对编译查询系统的支持；
**事务系统**由事务管理器、日志管理器、并发控制、锁管理器组成，日志管理器和驶入管理器完成对操作请求处理的事务一致性支持，锁管理器和并发控制提供对并发访问数据的一致性支持；
**系统表**是PostgreSQL数据库的元信息管理中心，包括数据库对象信息和数据库管理控制信息。

## 系统表

**数据字典**是关系数据库系统管理控制信息的核心，在PostgreSQL数据库系统中，系统表扮演者数据字典的角色。

系统表是PostgreSQL数据库存放结构元数据的地方，它在PostgreSQL中表现为存放有系统信息的普通表或者视图。

PostgreSQL的每一个数据库中都有自己的一套系统表，其中大多数系统表都是在数据库创建时从模板数据库中拷贝过来的，因此这些系统表里的数据都是与所属数据库相关的。只有少数系统表是所有数据库共享的（比如pg_database），这些系统表里的数据是关于所有数据库的。

### 主要系统表功能及依赖关系

1. pg_namespace
   系统表pg_namespace用于存储命名空间。命名空间是SQL92模式下层的结构：每个名字空间有独立的关系、类型等集合，但并不会相互冲突。PostgreSQL的名字空间层次是：数据库.模式.表.属性。
   pg_namespace中每一个元组都对应一个名字空间，每一个名字空间都被分配一个OID（对象标识，用于在整个数据库系统中唯一地标识一个数据库对象，包括数据库、表、视图、索引等）作为唯一标识，并且存储在对应元组的隐层属性（PosrgreSQL中每个元组都有几个用户不可见的属性，用于记录一些系统级的信息）中。

2. pg_tablespace
   pg_tablespace存储表空间信息，将表放置在不同的表空间有助于实施磁盘文件布局。pg_tablespace在整个数据集簇里只有一份，也就是说同一个数据集簇内的所有数据库共享一个pg_tablespace表，而不是每个数据库都有自己的pg_tablespace表。

3. pg_database
   pg_database中存放了当前数据集簇中数据库的信息，它也是一个在整个集簇范围内共享的系统表。

4. pg_class
   pg_class存储表及与表类似结构的数据库对象信息，包含索引、序列、视图、复合数据类型、TOAST表等。

5. pg_type
   pg_type存储数据类型信息。基本数据类型和枚举类型由CREATE TYPE创建，域类型由CREATE DOMAIN创建，复合数据类型在表创建时自动创建。

6. pg_attribute
   pg_attribute存储表的属性信息，对于数据库中表的每一个属性都有一个元组。

7. pg_index
   pg_index存储索引的具体信息。

### 系统视图

除了系统表之外，PostgreSQL还提供了一系列内置的视图，这些视图也是在初试化数据库集簇的时候读取脚本创建的。**系统视图提供了查询系统表和访问数据库内部状态的方法**。

## 数据集簇

由PostgreSQL管理的用户数据库以及系统数据库总称为数据集簇。

在PostgreSQL中，对象标识符（OID）用来在整个数据集簇中唯一地标识一个数据库对象，这个对象可以是数据库、表、索引、视图、元组、类型等。PostgreSQL提供了Oid数据类型来表示OID，它实际上是一个无符号整数。

对于用户表的元组，是可以在创建用户时选择是否具有OID属性的。默认状态下，用户表的元组是没有OID属性的。

OID的分配由系统中的一个全局OID计数器来实现，每次需要分配新的OID时，就从该计数器中取出当前的OID，然后该计数器将会加1。OID分配时会采用互斥锁加以锁定以避免多个要求分配OID的请求获得同一个OID。

初始化数据集簇包括创建包含数据库系统所有数据的数据目录、创建共享的系统表、创建其他的配置文件和控制文件，并创建三个数据库：末班数据库templae1和template0、默认的用户数据库postgres。以后用户创建一个新数据库时，template1数据库里的所有内容（包括系统表文件）都会拷贝过来，因此，任何在template1里面安装的内容都自动拷贝到之后创建的数据库中。template0和postgres都是通过拷贝template1创建的。

对于某个具体的数据库，在PGDATA/base里都对应有一个子目录，子目录的名字是该数据库在系统表pg_database里的OID。

如果一个标的有些属性要存储相当大的数据，那么就会有一个与之相关联的TOAST表，用于存储无法在数据行中放置的超大外置数据。

每个用户定义的表空间在PGDATA/pg_tblspc目录里面都有一个符号链接，它指向表空间的物理目录，该符号链接用表空间的OID命名。系统默认创建的表空间pg_default和pg_global并没有通过符号链接的方式指向其物理目录，而是直接对应PGDATA/base和PGDATA/global。

| 名称            | 类型  | 用途                                                                                                  |
| --------------- | :---: | ----------------------------------------------------------------------------------------------------- |
| PG_VERSION      | 文件  | 一个包含PostgreSQL主版本号的文件                                                                      |
| base            | 目录  | 包含每个数据库目录，数据库目录以数据库的OID编号命名，其中名为1的目录对应模板数据库template1。         |
| global          | 目录  | 包含整个集簇共享的全局表，比如pg_database                                                             |
| pg_clog         | 目录  | 包含事务提交状态数据的子目录                                                                          |
| pg_multixact    | 目录  | 包含多重事务状态数据的子目录（用于共享的行锁）                                                        |
| pg_stat_tmp     | 目录  | 包含统计子系统所需临时文件的子目录                                                                    |
| pg_tbspc        | 目录  | 包含指向表空间的符号链接的子目录                                                                      |
| pg_subtrans     | 目录  | 包含子事务状态数据的子目录                                                                            |
| pg_twophase     | 目录  | 包含用于预备事务的状态文件的子目录                                                                    |
| pg_xlog         | 目录  | 包含WAL（预写日志）文件的子目录                                                                       |
| postmaster.opts | 文件  | 记录服务器上一次启动时使用的命令行参数                                                                |
| postmaster.pid  | 文件  | 一个锁文件，记录着当前的守护进程Postmaster的进程号和共享内存段ID，在服务器关闭后此文件将被删除        |
| postgresql.conf | 文件  | 主要配置文件，除基于主机的访问控制和用户名映射之外的其他用户可设置参数都保存在这个文件中              |
| pg_hba.conf     | 文件  | 基于主机的访问控制文件，保存对客户端认证方式的设置信息                                                |
| pg_ident.conf   | 文件  | 用户名映射文件，定义了操作系统用户名和PostgreSQL用户名之间的对应关系，这些对应关系会被pg_hba.conf用到 |
